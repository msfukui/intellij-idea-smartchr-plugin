# IntelliJ IDEA SmartChr Plugin 要件定義と開発計画

## 1. プロジェクト概要

### 1.1 目的
Vimのvim-smartchrプラグインの機能をIntelliJ IDEAに移植し、同じキーを繰り返し押すことで事前定義された文字列パターンを循環入力できる機能を提供する。

### 1.2 背景
- vim-smartchrは開発効率を向上させる人気のVimプラグイン
- IntelliJ IDEAには同等の機能を持つプラグインが存在しない
- 多くの開発者がVimからIntelliJに移行する際、この機能を必要としている

## 2. 機能要件

### 2.1 コア機能

#### 2.1.1 キー循環機能
- **説明**: 単一キーの連続入力で、定義された文字列候補を順番に挿入・置換
- **動作例**: 
  - `=`キー: `=` → ` = ` → ` == ` → `=`（ループ）
  - `_`キー: `_` → ` <- `（ループなし）

#### 2.1.2 ファイルタイプ別設定
- **説明**: プログラミング言語ごとに異なるキーマッピングを設定可能
- **例**:
  - Java/Kotlin: `.` → `->` → `.`
  - Python: `:` → `: ` → `:`
  - R: `_` → ` <- ` → `_`

#### 2.1.3 カスタムキーマッピング
- **説明**: ユーザーが独自のキーと文字列パターンを定義可能
- **設定方法**: 
  - GUI設定画面
  - 設定ファイル（JSON/XML）

### 2.2 動作モード

#### 2.2.1 one_of モード
- 最後の候補に到達したら、それ以上循環しない
- 例: `smartchr.one_of(['_', ' <- '])`

#### 2.2.2 loop モード
- 最後の候補の次は最初の候補に戻る
- 例: `smartchr.loop(['.', '->', '...'])`

### 2.3 追加機能

#### 2.3.1 コンテキスト認識
- カーソル位置の前後の文字を認識
- より賢い候補選択（オプション）

#### 2.3.2 視覚的フィードバック
- 現在の候補位置をステータスバーに表示（オプション）
- ツールチップでの候補リスト表示

## 3. 非機能要件

### 3.1 パフォーマンス
- キー入力に対する遅延: 10ms以下
- メモリ使用量: 最小限に抑える

### 3.2 互換性
- IntelliJ IDEA: 2023.1以降
- Android Studio: 対応
- その他JetBrains IDE: 可能な限り対応

### 3.3 使いやすさ
- 直感的な設定UI
- デフォルト設定で一般的な使用ケースをカバー
- 詳細なドキュメント

## 4. 技術仕様

### 4.1 使用技術
- 言語: Kotlin
- ビルドツール: Gradle
- IntelliJ Platform SDK

### 4.2 主要コンポーネント

#### 4.2.1 SmartChrTypedHandler
- `TypedActionHandler`を実装
- キーストロークイベントを処理

#### 4.2.2 SmartChrSettings
- プラグイン設定の管理
- 永続化とロード

#### 4.2.3 SmartChrConfigurable
- 設定UIの実装
- `Configurable`インターフェースを実装

#### 4.2.4 SmartChrAction
- アクションの定義と登録

### 4.3 データ構造

```kotlin
data class SmartChrMapping(
    val key: Char,
    val candidates: List<String>,
    val mode: CycleMode,
    val fileTypes: List<String> = listOf("*")
)

enum class CycleMode {
    ONE_OF,  // 最後で停止
    LOOP     // 循環
}
```

## 5. 開発計画

### フェーズ1: 基本設定とプロジェクト構造（1週間）
- [ ] Gradleプロジェクトの初期化
- [ ] IntelliJ Platform Pluginの設定
- [ ] 基本的なディレクトリ構造の作成
- [ ] plugin.xmlの設定

### フェーズ2: コア機能の実装（2週間）
- [ ] SmartChrTypedHandlerの実装
- [ ] 基本的なキー循環ロジック
- [ ] 文字列の挿入・置換処理
- [ ] Undo/Redo対応

### フェーズ3: 設定管理（1週間）
- [ ] SmartChrSettingsの実装
- [ ] 設定の永続化
- [ ] ファイルタイプ別設定

### フェーズ4: UI実装（1週間）
- [ ] 設定画面の作成
- [ ] キーマッピングの追加・編集・削除UI
- [ ] プレビュー機能

### フェーズ5: 高度な機能（1週間）
- [ ] コンテキスト認識機能
- [ ] 視覚的フィードバック
- [ ] パフォーマンス最適化

### フェーズ6: テストとドキュメント（1週間）
- [ ] ユニットテストの作成
- [ ] 統合テスト
- [ ] ユーザードキュメントの作成
- [ ] プラグイン配布準備

## 6. マイルストーン

1. **M1**: 基本的なキー循環機能の動作（フェーズ2終了時）
2. **M2**: 設定画面からのカスタマイズ可能（フェーズ4終了時）
3. **M3**: プラグインマーケットプレイスへの公開準備完了（フェーズ6終了時）

## 7. リスクと対策

### 7.1 技術的リスク
- **リスク**: TypedActionHandlerの制限により、一部の機能が実装できない可能性
- **対策**: 代替APIの調査、IntelliJコミュニティへの相談

### 7.2 パフォーマンスリスク
- **リスク**: 頻繁なキー入力処理によるエディタのレスポンス低下
- **対策**: 効率的なアルゴリズムの実装、プロファイリングツールの使用

## 8. 成功基準

1. vim-smartchrの主要機能が再現されている
2. 設定が直感的で使いやすい
3. パフォーマンスが実用レベル
4. 主要なJetBrains IDEで動作する
5. ユーザーからの肯定的なフィードバック

## 9. 今後の拡張案

- 正規表現ベースのパターンマッチング
- チーム間での設定共有機能
- AIによる使用パターン学習と候補提案
- マクロ記録との統合